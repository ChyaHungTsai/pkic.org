{{- $data := .Page.Params.data -}}
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PKI Consortium//NONSGML v1.0//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
REFRESH-INTERVAL;VALUE=DURATION:P1H
{{- range $date, $slots := $data.agenda -}}
    {{- range $slot := $slots -}}
        {{- range $session := $slot.sessions -}}
            {{- $description := ((replaceRE "\n+" " " ($session.description | markdownify)) | default "No description available") }}
BEGIN:VEVENT
UID:{{ printf "%s-%s-%s" $session.locations $date $slot.time | urlize }}@ics.pkic.org
DTSTAMP:{{ now.Format "20060102T150405Z" }}
DTSTART:{{ ( time.AsTime (printf "%sT%s:00" $date $slot.time) $data.timezone ).UTC | time.Format "20060102T150405Z" }}
SUMMARY:{{ strings.TrimSpace (replaceRE "(.{70})" "${1}\n    " $session.title | default "No title available") }}
DESCRIPTION: 
    {{ strings.TrimSpace (replaceRE "(.{70})" "${1}\n    " (replaceRE "\n+" " " ($description | plainify))) }}
X-ALT-DESC;FMTTYPE=text/html:
    {{ strings.TrimSpace (replaceRE "(.{70})" "${1}\n    " $description) }}
{{- range $index, $location := $session.locations -}}
    {{ if not $index }}
LOCATION:{{ strings.FirstUpper $location }}
COLOR:{{ (index $data.locations $location).color }}
    {{- end }}
CONFERENCE;VALUE=URI;FEATURE=AUDIO,VIDEO,SCREEN;
    LABEL=Livestream:{{ (index $data.locations $location).livestream }}
{{- end }}
{{ range $session.speakers -}}
ATTENDEE;ROLE=REQ-PARTICIPANT;PARTSTAT=ACCEPTED;
    CN={{ . }}
    :MAILTO:noreply@pkic.org
{{ end -}}
END:VEVENT
        {{- end }}
    {{- end -}}
{{- end }}
END:VCALENDAR